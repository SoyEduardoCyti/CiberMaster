<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Costos de Impresi√≥n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
            margin-bottom: 20px;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            color: #333;
        }

        .header svg {
            width: 40px;
            height: 40px;
            color: #667eea;
        }

        .header h1 {
            font-size: 2em;
        }

        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 30px;
        }

        .upload-zone:hover {
            border-color: #764ba2;
            background: #f8f9ff;
        }

        .upload-zone svg {
            width: 60px;
            height: 60px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 15px;
            transition: background 0.3s;
        }

        .upload-btn:hover {
            background: #764ba2;
        }

        #fileInput {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .files-section {
            display: none;
        }

        .section-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-item {
            background: #f8f9ff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .file-price {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .discount-section {
            background: #f0f4ff;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .discount-label {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .discount-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
        }

        .total-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 25px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .total-final {
            border-top: 2px solid rgba(255,255,255,0.3);
            padding-top: 15px;
            margin-top: 15px;
        }

        .total-final .total-row {
            font-size: 2em;
            font-weight: bold;
        }

        .info-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            font-size: 0.9em;
            color: #666;
        }

        .info-card h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .info-card ul {
            list-style: none;
        }

        .info-card li {
            padding: 5px 0;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .badge-color {
            background: #ffd700;
            color: #333;
        }

        .badge-bn {
            background: #e0e0e0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="2" width="6" height="4"></rect>
                    <path d="M4 9h16"></path>
                    <path d="M4 13h16"></path>
                    <path d="M4 17h16"></path>
                    <rect x="3" y="5" width="18" height="16" rx="2"></rect>
                </svg>
                <h1>Calculadora de Impresi√≥n</h1>
            </div>

            <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <h2>Selecciona archivos para calcular</h2>
                <p style="color: #666; margin-top: 10px;">PDF, Im√°genes (JPG, PNG) o Word</p>
                <button class="upload-btn">Cargar Archivos</button>
                <input type="file" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analizando archivos...</p>
            </div>

            <div class="files-section" id="filesSection">
                <h2 class="section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    Archivos Analizados
                </h2>
                <div id="filesList"></div>

                <div class="discount-section">
                    <div class="discount-label">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="19" y1="5" x2="5" y2="19"></line>
                            <circle cx="6.5" cy="6.5" r="2.5"></circle>
                            <circle cx="17.5" cy="17.5" r="2.5"></circle>
                        </svg>
                        Aplicar Descuento (%)
                    </div>
                    <input type="number" class="discount-input" id="discountInput" min="0" max="100" value="0" placeholder="% de descuento">
                </div>

                <div class="total-section" id="totalSection">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="total-row" id="discountRow" style="display: none; opacity: 0.8;">
                        <span>Descuento (<span id="discountPercent">0</span>%):</span>
                        <span id="discountAmount">-$0.00</span>
                    </div>
                    <div class="total-final">
                        <div class="total-row">
                            <span>TOTAL:</span>
                            <span id="total">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-card">
            <h3>üìã Tarifas de Impresi√≥n</h3>
            <ul>
                <li>‚Ä¢ Texto Blanco y Negro: <strong>$2.00 por p√°gina</strong></li>
                <li>‚Ä¢ Color (50% tinta): <strong>$8.00 por p√°gina</strong></li>
                <li>‚Ä¢ Color (100% tinta): <strong>$14.00 por p√°gina</strong></li>
                <li>‚Ä¢ El precio de color se calcula proporcionalmente seg√∫n el % de tinta</li>
            </ul>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let archivos = [];

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('filesSection').style.display = 'none';

            archivos = await Promise.all(files.map(procesarArchivo));
            
            document.getElementById('loading').style.display = 'none';
            mostrarArchivos();
            calcularTotales();
        });

        document.getElementById('discountInput').addEventListener('input', () => {
            calcularTotales();
        });

        async function procesarArchivo(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            
            if (ext === 'pdf') {
                return await analizarPDF(file);
            } else if (['jpg', 'jpeg', 'png'].includes(ext)) {
                return await analizarImagen(file);
            } else if (['doc', 'docx'].includes(ext)) {
                return await analizarWord(file);
            }
            
            return {
                nombre: file.name,
                tipo: 'Desconocido',
                paginas: 1,
                porcentajeTinta: 20,
                tieneColor: false
            };
        }

        async function analizarPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const numPaginas = pdf.numPages;
                
                // Analizar algunas p√°ginas para detectar color
                let tieneColor = false;
                let tieneImagenes = false;
                
                const paginasAAnalizar = Math.min(3, numPaginas);
                for (let i = 1; i <= paginasAAnalizar; i++) {
                    const page = await pdf.getPage(i);
                    const ops = await page.getOperatorList();
                    
                    for (let j = 0; j < ops.fnArray.length; j++) {
                        if (ops.fnArray[j] === pdfjsLib.OPS.paintImageXObject) {
                            tieneImagenes = true;
                        }
                        if (ops.fnArray[j] === pdfjsLib.OPS.setFillRGBColor || 
                            ops.fnArray[j] === pdfjsLib.OPS.setStrokeRGBColor) {
                            const args = ops.argsArray[j];
                            if (args && args.length >= 3) {
                                if (!(args[0] === args[1] && args[1] === args[2])) {
                                    tieneColor = true;
                                }
                            }
                        }
                    }
                }
                
                let porcentajeTinta = 15;
                if (tieneImagenes) porcentajeTinta += 35;
                if (tieneColor) porcentajeTinta += 30;
                
                return {
                    nombre: file.name,
                    tipo: 'PDF',
                    paginas: numPaginas,
                    porcentajeTinta: Math.min(porcentajeTinta, 100),
                    tieneColor: tieneColor || tieneImagenes
                };
            } catch (error) {
                console.error('Error analizando PDF:', error);
                return {
                    nombre: file.name,
                    tipo: 'PDF',
                    paginas: 1,
                    porcentajeTinta: 30,
                    tieneColor: false
                };
            }
        }

        async function analizarImagen(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                const img = new Image();
                
                reader.onload = (e) => {
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        const maxSize = 200;
                        const scale = Math.min(maxSize / img.width, maxSize / img.height);
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const pixels = imageData.data;
                        
                        let totalBrightness = 0;
                        let colorPixels = 0;
                        
                        for (let i = 0; i < pixels.length; i += 4) {
                            const r = pixels[i];
                            const g = pixels[i + 1];
                            const b = pixels[i + 2];
                            
                            const brightness = (r + g + b) / 3;
                            totalBrightness += (255 - brightness);
                            
                            const maxDiff = Math.max(Math.abs(r - g), Math.abs(g - b), Math.abs(r - b));
                            if (maxDiff > 30) colorPixels++;
                        }
                        
                        const avgDarkness = totalBrightness / (pixels.length / 4);
                        const porcentajeTinta = Math.round((avgDarkness / 255) * 100);
                        const esColor = (colorPixels / (pixels.length / 4)) > 0.1;
                        
                        resolve({
                            nombre: file.name,
                            tipo: 'Imagen',
                            paginas: 1,
                            porcentajeTinta: Math.max(porcentajeTinta, 15),
                            tieneColor: esColor
                        });
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function analizarWord(file) {
            const arrayBuffer = await file.arrayBuffer();
            const size = arrayBuffer.byteLength;
            
            const estimatedPages = Math.ceil(size / 50000);
            
            const uint8Array = new Uint8Array(arrayBuffer);
            const text = new TextDecoder('utf-8', { fatal: false }).decode(uint8Array);
            const tieneImagenes = text.includes('image') || text.includes('png') || text.includes('jpeg');
            
            return {
                nombre: file.name,
                tipo: 'Word',
                paginas: estimatedPages,
                porcentajeTinta: tieneImagenes ? 60 : 15,
                tieneColor: tieneImagenes
            };
        }

        function calcularCosto(info) {
            const { paginas, porcentajeTinta, tieneColor } = info;
            
            if (tieneColor) {
                const costoBase = 8;
                const costoMax = 14;
                const factor = Math.max(0, (porcentajeTinta - 50) / 50);
                const costoPorPagina = costoBase + (costoMax - costoBase) * factor;
                return costoPorPagina * paginas;
            } else {
                return 2 * paginas;
            }
        }

        function mostrarArchivos() {
            const filesList = document.getElementById('filesList');
            filesList.innerHTML = '';
            
            archivos.forEach(archivo => {
                const costo = calcularCosto(archivo);
                archivo.costo = costo;
                
                const div = document.createElement('div');
                div.className = 'file-item';
                div.innerHTML = `
                    <div class="file-header">
                        <div class="file-info">
                            <div class="file-name">
                                üìÑ ${archivo.nombre}
                                <span class="badge ${archivo.tieneColor ? 'badge-color' : 'badge-bn'}">
                                    ${archivo.tieneColor ? 'COLOR' : 'B/N'}
                                </span>
                            </div>
                            <div class="file-details">
                                <div><strong>P√°ginas:</strong> ${archivo.paginas}</div>
                                <div><strong>Tipo:</strong> ${archivo.tipo}</div>
                                <div><strong>Tinta:</strong> ${archivo.porcentajeTinta}%</div>
                            </div>
                        </div>
                        <div class="file-price">$${costo.toFixed(2)}</div>
                    </div>
                `;
                filesList.appendChild(div);
            });
            
            document.getElementById('filesSection').style.display = 'block';
        }

        function calcularTotales() {
            const subtotal = archivos.reduce((sum, arch) => sum + arch.costo, 0);
            const descuento = parseFloat(document.getElementById('discountInput').value) || 0;
            const montoDescuento = (subtotal * descuento) / 100;
            const total = subtotal - montoDescuento;
            
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
            
            if (descuento > 0) {
                document.getElementById('discountRow').style.display = 'flex';
                document.getElementById('discountPercent').textContent = descuento;
                document.getElementById('discountAmount').textContent = `-$${montoDescuento.toFixed(2)}`;
            } else {
                document.getElementById('discountRow').style.display = 'none';
            }
        }
    </script>
</body>
</html>